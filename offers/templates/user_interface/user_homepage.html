{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>User ‚Ä¢ OfferZone</title>

  <!-- libs -->
  <script src="https://unpkg.com/html5-qrcode" defer></script>

  <style>
    :root{
  --bg:#0b1020;
  --card:#11183a;
  --border:#273164;
  --text:#e8ecff;
  --muted:#b9c4ff;
  --prim:#4c74ff;

  /* light card theme (branches) */
  --lightCard:#ffffff;
  --lightCard2:#f6f8ff;
  --lightBorder:rgba(15,23,42,0.10);
  --lightText:#0f172a;
  --lightMuted:#475569;

  /* status colors */
  --ok:rgba(34,197,94,0.65);
  --okBar:rgba(34,197,94,0.75);
  --bad:rgba(239,68,68,0.55);
  --badBar:rgba(239,68,68,0.65);
}

*{ box-sizing:border-box }
body{
  margin:0;
  font-family:system-ui, Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
}
a{ color:#c5d0ff; text-decoration:none }
a:hover{ opacity:.9 }

/* Header */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:14px 18px;
  background:var(--card);
  border-bottom:1px solid var(--border);
  position:sticky;
  top:0;
  z-index:10;
}
header .brand{ font-weight:700; letter-spacing:.3px }
header .right{ display:flex; gap:12px; align-items:center }

/* Buttons */
.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:10px 14px;
  border-radius:12px;
  border:1px solid var(--border);
  background:var(--prim);
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
.btn.outline{
  background:transparent;
  color:var(--text);
}

/* Layout */
.wrap{ max-width:980px; margin:28px auto; padding:0 16px }

/* Base card */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:18px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}

/* Messages */
.msg{
  background:#0e1a48;
  border:1px solid var(--border);
  padding:10px 12px;
  border-radius:10px;
  margin-bottom:12px;
}

/* Hero */
.hero{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:16px;
  flex-wrap:wrap;
}
.hero h1{ margin:0; font-size:22px }

/* Quick tiles */
.grid{
  display:grid;
  grid-template-columns:repeat(2, minmax(0, 1fr));
  gap:14px;
}
@media (min-width:740px){
  .grid{ grid-template-columns:repeat(3, minmax(0, 1fr)); }
}
.tile{
  background:#0f1640;
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.tile strong{ font-size:16px }
.tile small{ color:var(--muted) }

/* Tap-to-Scan hero */
.scan-hero{
  position:relative;
  border-radius:20px;
  padding:18px;
  background:linear-gradient(180deg,#2b48ff 0%, #5a86ff 60%, #6aa1ff 100%);
  color:#fff;
  box-shadow:0 16px 40px rgba(0,0,0,.35);
  overflow:hidden;
  min-height:150px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.scan-hero__inner{ text-align:center; user-select:none; cursor:pointer }
.scan-hero__qr{
  width:88px;
  height:88px;
  margin:6px auto 10px;
  border-radius:14px;
  background:rgba(255,255,255,.14);
  display:grid;
  place-items:center;
  position:relative;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.25);
}
.scan-hero__qr::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:14px;
  border:2px dashed rgba(255,255,255,.35);
  mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite:xor;
  mask-composite:exclude;
  padding:10px;
}
.scan-hero__corners{ position:absolute; inset:0; pointer-events:none }
.scan-hero__corner{ position:absolute; width:34px; height:34px; border:4px solid #bfe0ff; border-radius:10px }
.scan-hero__corner.tl{ top:18px; left:18px; border-right:none; border-bottom:none }
.scan-hero__corner.tr{ top:18px; right:18px; border-left:none; border-bottom:none }
.scan-hero__corner.bl{ bottom:18px; left:18px; border-right:none; border-top:none }
.scan-hero__corner.br{ bottom:18px; right:18px; border-left:none; border-top:none }
.scan-hero__text{ font-weight:800; letter-spacing:.2px; font-size:18px }
.scan-hero__sub{ opacity:.9; font-size:12px }
.qr-ic{ width:34px; height:34px; display:inline-block }
.qr-ic svg{ width:100%; height:100%; opacity:.95 }

/* Branch list header + grid */
.br-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px }
.br-head strong{ font-size:16px }
.br-grid{ display:grid; grid-template-columns:repeat(2, minmax(0, 1fr)); gap:10px }
@media(min-width:740px){
  .br-grid{ grid-template-columns:repeat(3, minmax(0, 1fr)); }
}
.view-all{ font-size:12px; color:#c5d0ff }

/* =========================
   BRANCHES CARD (LIGHT)
   ========================= */
.card.card-branches{
  background:linear-gradient(180deg, var(--lightCard) 0%, var(--lightCard2) 100%);
  border:1px solid var(--lightBorder);
  border-radius:22px;
  box-shadow:0 18px 50px rgba(0,0,0,0.30);
}

/* head text inside */
.card-branches .br-head strong{ color:var(--lightText) }
.card-branches .view-all{ color:var(--prim) }

/* tiles (base) */
.card-branches .branch-tile{
  background:#ffffff;
  border-radius:16px;
  padding:12px 14px;
  display:flex;
  flex-direction:column;
  gap:6px;

  border:1px solid var(--lightBorder);
  box-shadow:0 10px 22px rgba(15,23,42,0.08);
  transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
  text-decoration:none;
}
.card-branches .branch-tile:hover{
  transform:translateY(-3px);
  box-shadow:0 16px 30px rgba(15,23,42,0.14);
}

/* text inside tiles */
.card-branches .branch-name{
  color:var(--lightText);
  font-weight:800;
  letter-spacing:.2px;
}
.card-branches .branch-meta{
  color:var(--lightMuted);
  font-size:12px;
}

/* ACTIVE */
.card-branches .branch-tile--active{
  border:2px solid var(--ok);
  box-shadow:
    0 14px 28px rgba(34,197,94,0.16),
    0 10px 22px rgba(15,23,42,0.08);
}
.card-branches .branch-tile--active::before{
  content:"";
  display:block;
  height:4px;
  border-radius:999px;
  background:var(--okBar);
  margin-bottom:6px;
}

/* INACTIVE */
.card-branches .branch-tile--inactive{
  border:2px solid var(--bad);
  box-shadow:
    0 14px 28px rgba(239,68,68,0.10),
    0 10px 22px rgba(15,23,42,0.08);
}
.card-branches .branch-tile--inactive::before{
  content:"";
  display:block;
  height:4px;
  border-radius:999px;
  background:var(--badBar);
  margin-bottom:6px;
}

/* GEO */
.geo-wrap{ display:grid; gap:10px; margin-top:10px }
.geo-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
.input{ display:flex; flex-direction:column; gap:6px; min-width:220px; flex:1 }
.input label{ font-size:12px; color:var(--muted) }
.input input{
  width:100%;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#0f1640;
  color:var(--text);
  font-weight:600;
}
.chip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border:1px solid var(--border);
  background:#0e1a48;
  color:var(--muted);
  border-radius:999px;
  font-size:12px;
}
.geo-error{ display:none }
.geo-error.show{ display:block; background:#3c1a1a; border-color:#6b2b2b }

/* Bottom tabs */
footer.nav{
  position:sticky;
  bottom:0;
  background:var(--card);
  border-top:1px solid var(--border);
}
.tabs{ display:grid; grid-template-columns:repeat(4,1fr); gap:0 }
.tab{ padding:10px 8px; text-align:center; color:var(--muted) }
.tab.active{ color:#fff; border-bottom:2px solid var(--prim) }

  </style>

</head>
<body data-oz-already-claimed="{{ oz_already_claimed_today|yesno:'1,0' }}">
  <header>
    <!-- <p>Your IP: {{ client_ip }}</p> -->

    <div class="brand">OfferZone</div>
    <div class="right">
      <a class="btn outline" href="#">Profile</a>

      <a href="{% url 'offers:user_status' %}">Status</a>
    </div>
  </header>

  <main class="wrap">
    {% if messages %}
      {% for m in messages %}<div class="msg">{{ m }}</div>{% endfor %}
    {% endif %}

    <!-- Tap to Scan -->
    <div class="scan-hero" id="tapToScan" role="button" tabindex="0" aria-label="Tap to scan branch QR">
      <div class="scan-hero__corners">
        <span class="scan-hero__corner tl"></span>
        <span class="scan-hero__corner tr"></span>
        <span class="scan-hero__corner bl"></span>
        <span class="scan-hero__corner br"></span>
      </div>
      <div class="scan-hero__inner">
        <div class="scan-hero__qr">
          <span class="qr-ic">
            <svg viewBox="0 0 24 24" fill="none">
              <rect x="3" y="3" width="7" height="7" rx="1.6" stroke="white" stroke-width="2"/>
              <rect x="14" y="3" width="7" height="7" rx="1.6" stroke="white" stroke-width="2"/>
              <rect x="3" y="14" width="7" height="7" rx="1.6" stroke="white" stroke-width="2"/>
              <path d="M14 14h3v3h-3v-3Zm5 0h2v5h-2v-5Zm-5 5h5v2h-5v-2Z" fill="white"/>
            </svg>
          </span>
        </div>
        <div class="scan-hero__text">Tap to scan</div>
        <div class="scan-hero__sub">Scan counter QR to open branch offers</div>
      </div>
    </div>

    
    <!-- inline success banner after scan -->
    <div id="scanInlineMsg" class="msg" style="display:none; margin-top:12px"></div>

    <!-- Welcome + Geo -->
    <div class="card hero" style="margin-top:16px">
      <div style="flex:1 1 420px; min-width:280px">
        <h1>
          Welcome
          {% if request.user.is_authenticated %}
            {% if display_name %}, {{ display_name }}
            {% elif request.user.first_name %}, {{ request.user.first_name }}
            {% elif request.user.username %}, {{ request.user.username }}
            {% else %}, {{ request.user.email }}
            {% endif %}
          {% endif %} üëã
        </h1>
        <span id="helloName">
          Hello{% if display_name %} : {{ display_name }}
          {% elif request.user.first_name %} : {{ request.user.first_name }}
          {% else %} :
          {% endif %}
        </span>
        <p style="margin:.3rem 0 0; color:var(--muted)">Browse today‚Äôs menu, collect visits, and claim offers.</p>

        <div class="geo-wrap" aria-live="polite">
          <div class="geo-row">
            <button type="button" class="btn outline" id="btnUseLocation">Use current location</button>
            <span id="locAccuracy" class="chip" title="Estimated accuracy">Accuracy: ‚Äî</span>
            <span id="locStatus" class="chip" title="Status">Idle</span>
          </div>
          <div class="geo-row">
            <div class="input">
              <label for="latitude">Latitude</label>
              <input id="latitude" name="latitude" type="text" inputmode="decimal" autocomplete="off" readonly placeholder="‚Äî">
            </div>
            <div class="input">
              <label for="longitude">Longitude</label>
              <input id="longitude" name="longitude" type="text" inputmode="decimal" autocomplete="off" readonly placeholder="‚Äî">
            </div>
          </div>
          <div id="locError" class="msg geo-error" role="alert"></div>
        </div>
      </div>
      <a class="btn" href="#">View Today‚Äôs Menu</a>
    </div>

    <!-- Branches -->
<!-- Branches -->
<div class="card card-branches" style="margin-top:16px">

  <div class="br-head">
    <strong>Branches ({{ branch_count }})</strong>
    {% if branches_has_more %}<a class="view-all" href="#">View all</a>{% endif %}
  </div>
  {% if branch_count %}
    <div class="br-grid">
      {% for b in branches %}
      <!-- ikkada change: div ‚Üí <a> + href -->
      <a
  class="branch-tile {% if b.offer_start %}branch-tile--active{% else %}branch-tile--inactive{% endif %}"
  href="{% url 'offers:branch_offers_in_userinterface' b.id %}">

        <div class="branch-name">{{ b.name }}</div>
        {% if b.latitude and b.longitude %}
          <div class="branch-meta">üìç {{ b.latitude }}, {{ b.longitude }}</div>
        {% else %}
          <div class="branch-meta">‚Äî location not set</div>
        {% endif %}


          <!-- ‚úÖ ADD THIS HERE (location tarvaatha) -->
  {% if b.offer_start %}
    <div class="branch-meta">
      üóì {{ b.offer_start|date:"d M Y" }}
      {% if b.offer_end %}
        ‚Äì {{ b.offer_end|date:"d M Y" }}
      {% else %}
        ‚Äì onwards
      {% endif %}
    </div>
  {% else %}
    <div class="branch-meta">üóì No active offer</div>
  {% endif %}

  
      </a>
      {% endfor %}
    </div>
  {% else %}
    <div class="msg">No branches yet.</div>
  {% endif %}
</div>



    <!-- Quick tiles -->
    <div class="wrap" style="padding:0; margin-top:16px">
      <div class="grid">
        <a class="tile" href="#" data-open="#freeplateCalendarModal">
          <strong>Enjoy Your Free Treat</strong><small>Visit count & free Treat progress</small>
        </a>
        <a class="tile" href="#"><strong>Today‚Äôs Offers</strong><small>Active deals you can claim now</small></a>
        <a class="tile" href="#"><strong>Order History</strong><small>Past redemptions & invoices</small></a>
        <a class="tile" href="#"><strong>Account & Help</strong><small>Profile, support, FAQs</small></a>
        <a class="tile" href="#"><strong>Locations</strong><small>Nearby partner canteens</small></a>
        <a class="tile" href="#"><strong>Refer & Earn</strong><small>Invite friends and get rewards</small></a>
      </div>
    </div>
  </main>

  <footer class="nav">
    <div class="tabs">
      <a class="tab active" href="#">Home</a>
      <a class="tab" href="#">Offers</a>
      <a class="tab" href="#">Account</a>
      <a href="{% url 'offers:user_logout' %}">Sign out</a>

    </div>
  </footer>
  {% include "user_interface/user_name_modal.html" %}
  {% include "user_interface/free_treat_calendar_modal.html" %}
  {% include "user_interface/scan_modal/scan_modal.html" %}
  {% include "user_interface/scan_modal/already_claimed_modal.html" %}


  <!-- Scanner JS (moved to static) -->

  <!-- Geo script (unchanged logic) -->
  <script>
    (() => {
      const latEl = document.getElementById('latitude');
      const lonEl = document.getElementById('longitude');
      const accEl = document.getElementById('locAccuracy');
      const statusEl = document.getElementById('locStatus');
      const errEl = document.getElementById('locError');
      const btn = document.getElementById('btnUseLocation');

      const GP_OPTS = { enableHighAccuracy: true, timeout: 20000, maximumAge: 10000 };
      const COOL_MS = 60000, MIN_MOVE = 30, MAX_ACC = 100;
      let watcherId = null, lastSaved = null, lastPostedAt = 0;

      const setStatus = (t) => statusEl && (statusEl.textContent = t);
      const setError = (msg) => { if (!errEl) return; if (!msg) { errEl.classList.remove('show'); errEl.textContent = ''; return; } errEl.textContent = msg; errEl.classList.add('show'); };
      const fmt = (n) => (typeof n === 'number' ? n : Number(n)).toFixed(6);
      const setPosition = (lat, lon, acc) => { if (latEl) latEl.value = fmt(lat); if (lonEl) lonEl.value = fmt(lon); if (accEl) accEl.textContent = 'Accuracy: ¬±' + (isFinite(acc) ? Math.round(acc) : '‚Äî') + ' m'; };
      const isSecure = () => location.protocol === 'https:' || ['localhost', '127.0.0.1', '[::1]'].includes(location.hostname);

      function getCookie(name) { return document.cookie.split('; ').find(r => r.startsWith(name + '='))?.split('=')[1] || ''; }
      async function postLocation(lat, lon, accuracy) {
        try {
          await fetch("{% url 'offers:save_location' %}", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken"), "X-Requested-With": "XMLHttpRequest" },
            body: JSON.stringify({ latitude: lat, longitude: lon, accuracy, source: "browser" })
          });
        } catch (e) { console.debug("save_location failed:", e); }
      }

      function getOnce() { return new Promise((res, rej) => { if (!('geolocation' in navigator)) return rej(new Error('Geolocation not supported.')); navigator.geolocation.getCurrentPosition(res, rej, GP_OPTS); }); }
      function distM(a, b, c, d) { const R = 6371000, toRad = (x) => x * Math.PI / 180; const dLa = toRad(c - a), dLo = toRad(d - b); const A = Math.sin(dLa / 2) ** 2 + Math.cos(toRad(a)) * Math.cos(toRad(c)) * Math.sin(dLo / 2) ** 2; return 2 * R * Math.asin(Math.sqrt(A)); }
      function maybePost(lat, lon, acc) {
        const now = Date.now(); if (!isFinite(lat) || !isFinite(lon)) return; if (!isFinite(acc) || acc > MAX_ACC) return;
        if (now - lastPostedAt < COOL_MS) return;
        if (lastSaved) { const d = distM(lastSaved.lat, lastSaved.lon, lat, lon); if (d < MIN_MOVE) return; }
        lastSaved = { lat, lon, t: now }; lastPostedAt = now; postLocation(lat, lon, acc);
      }

      async function requestNow() {
        setError(''); setStatus('Locating‚Ä¶'); if (accEl) accEl.textContent = 'Accuracy: ‚Äî';
        try {
          if (!isSecure()) setError('Tip: use https:// or localhost/127.0.0.1 for location access.');
          const pos = await getOnce(); const { latitude, longitude, accuracy } = pos.coords || {};
          setPosition(latitude, longitude, accuracy ?? NaN); setStatus('Location set'); maybePost(latitude, longitude, accuracy ?? NaN);
        } catch (e) {
          setStatus('Idle'); const msg = String(e && (e.message || e)).toLowerCase();
          if (msg.includes('permission') || msg.includes('denied')) setError('Permission denied. Allow Location in Site settings, then try again.');
          else if (msg.includes('secure origin')) setError('Blocked on this URL. Use https:// (ngrok) or localhost/127.0.0.1.');
          else if (msg.includes('position unavailable')) setError('Position unavailable. Turn ON device Location and try again.');
          else setError(e && e.message ? e.message : 'Could not get location');
        }
      }

      function startWatch() {
        if (watcherId !== null || !('geolocation' in navigator)) return;
        try {
          watcherId = navigator.geolocation.watchPosition((pos) => {
            const { latitude, longitude, accuracy } = pos.coords || {};
            setPosition(latitude, longitude, accuracy ?? NaN); maybePost(latitude, longitude, accuracy ?? NaN); setStatus('Watching‚Ä¶');
          }, () => setStatus('Idle'), GP_OPTS);
        } catch { }
      }
      function stopWatch() { if (watcherId !== null) { navigator.geolocation.clearWatch(watcherId); watcherId = null; setStatus('Idle'); } }

      async function init() {
        let state = 'prompt';
        try {
          if ('permissions' in navigator && navigator.permissions.query) {
            const p = await navigator.permissions.query({ name: 'geolocation' }); state = p.state;
            p.onchange = () => {
              if (p.state === 'granted') { setError(''); requestNow(); startWatch(); }
              else if (p.state === 'prompt') { stopWatch(); setError('Click ‚ÄúUse current location‚Äù to allow access.'); }
              else { stopWatch(); setError('Location is blocked. Enable in Site settings.'); }
            };
          }
        } catch { }
        if (state === 'granted') { setTimeout(requestNow, 300); startWatch(); }
        else if (state === 'prompt') { setError('Click ‚ÄúUse current location‚Äù to allow access.'); }
        else { setError('Location is blocked. Enable in Site settings.'); }
      }

      btn?.addEventListener('click', requestNow);
      document.addEventListener('visibilitychange', () => { if (document.hidden) stopWatch(); else if (watcherId === null && (statusEl?.textContent !== 'Watching‚Ä¶')) startWatch(); });
      init();
    })();

    // Avoid back-to-open-modal oddity on first load
    if (window.history && window.history.replaceState) {
      window.history.replaceState(null, '', window.location.href);
    }
  </script>.

  
</body>
</html>
