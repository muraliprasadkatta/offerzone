{# user_interface/user_visit_count/eligibility_preview_modal.html #}

<style>
  :root{
    --ep-bg:#0b1020;
    --ep-card:#11183a;
    --ep-border:#273164;
    --ep-text:#e8ecff;
    --ep-muted:#b9c4ff;
    --ep-prim:#4c74ff;
  }

  /* overlay */
  #eligibilityPreviewOverlay{
    position:fixed;
    inset:0;
    z-index:80;
    display:none;
    align-items:center;
    justify-content:center;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    color:var(--ep-text);
    padding:16px;

    background:
      radial-gradient(900px 500px at 30% 20%, rgba(76,116,255,.28), transparent 60%),
      radial-gradient(800px 420px at 80% 70%, rgba(106,161,255,.20), transparent 55%),
      linear-gradient(180deg, #0b1020 0%, #090d1a 100%);
  }
  #eligibilityPreviewOverlay.is-open{ display:flex; }

  .epCard{
    width:min(460px, 96vw);
    background:
      radial-gradient(120% 80% at 50% 0%,
        rgba(120,150,255,.18),
        rgba(17,24,58,.92) 60%),
      linear-gradient(180deg,
        rgba(25,35,85,.95),
        rgba(12,18,48,.95));
    border: 1px solid rgba(170,200,255,.28);
    border-radius: 22px;
    box-shadow:
      0 30px 70px rgba(0,0,0,.55),
      0 0 0 1px rgba(255,255,255,.06) inset,
      0 0 90px rgba(76,116,255,.25);
    padding:18px;
    position:relative;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  .epHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }

  .epLeft{
    display:flex;
    align-items:center;
    gap:10px;
  }

  .epEmoji{
    width:42px;
    height:42px;
    border-radius:14px;
    display:flex;
    align-items:center;
    justify-content:center;
    background: rgba(255,255,255,.08);
    border:1px solid rgba(190,220,255,.20);
    box-shadow: 0 8px 22px rgba(0,0,0,.25);
    font-size:22px;
  }

  .epTitle{
    font-weight:950;
    font-size:16px;
    line-height:1.1;
  }
  .epSub{
    margin-top:3px;
    font-size:12px;
    color: rgba(185,196,255,.92);
    line-height:1.35;
  }

  .epBadge{
    padding:8px 12px;
    border-radius:999px;
    font-weight:950;
    font-size:12px;
    background: rgba(255,76,106,.10);
    border:1px solid rgba(255,76,106,.30);
    color:#ffd4dc;
    white-space:nowrap;
  }

  .epPills{
    margin-top:12px;
    display:flex;
    gap:10px;
    justify-content:flex-start;
    flex-wrap:wrap;
  }
  .epPill{
    padding:8px 12px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    background: rgba(255,255,255,.06);
    border:1px solid rgba(190,220,255,.20);
    color: rgba(232,236,255,.95);
  }

  .epNote{
    margin-top:12px;
    padding:12px 12px;
    border-radius:16px;
    background: rgba(255,255,255,.06);
    border:1px dashed rgba(190,220,255,.28);
    color: rgba(232,236,255,.90);
    font-size:12px;
    line-height:1.45;
    text-align:left;
  }

  /* checkbox row */
  .epCheckRow{
    margin-top:12px;
    display:flex;
    gap:10px;
    align-items:flex-start;
    padding:10px 10px;
    border-radius:16px;
    background: rgba(255,255,255,.04);
    border:1px solid rgba(190,220,255,.16);
  }
  .epCheckRow input[type="checkbox"]{
    margin-top:3px;
    width:18px;
    height:18px;
    accent-color: var(--ep-prim);
    cursor:pointer;
  }
  .epCheckText{
    font-size:12px;
    line-height:1.4;
    color: rgba(232,236,255,.92);
    font-weight:800;
  }
  .epCheckHint{
    margin-top:4px;
    font-size:11px;
    color: rgba(185,196,255,.9);
    font-weight:700;
  }

  .epActions{
    margin-top:14px;
    display:flex;
    gap:12px;
  }
  .epBtn{
    flex:1;
    padding:12px 14px;
    border-radius:18px;
    border:1px solid rgba(190,220,255,.22);
    background: rgba(255,255,255,.06);
    color:#fff;
    font-size:14px;
    font-weight:950;
    cursor:pointer;
  }
  .epBtn:active{ transform:translateY(1px); }

  .epBtnPrimary{
    border:1px solid rgba(39,49,100,.95);
    background: var(--ep-prim);
    box-shadow:0 10px 26px rgba(76,116,255,.22);
  }
  .epBtnPrimary[disabled]{
    opacity:.55;
    cursor:not-allowed;
    box-shadow:none;
  }

  /* loading state */
  .epLoading{
    margin-top:12px;
    font-size:12px;
    color: rgba(185,196,255,.92);
    text-align:left;
  }

  @media (max-width: 420px){
    .epCard{ padding:16px; }
    .epBadge{ font-size:11px; padding:7px 10px; }
    .epBtn{ padding:12px 12px; font-size:14px; }
  }
</style>

<div id="eligibilityPreviewOverlay" aria-hidden="true">
  <div class="epCard" role="dialog" aria-modal="true" aria-labelledby="epTitle">
    <div class="epHeader">
      <div class="epLeft">
        <div class="epEmoji" id="epEmoji">ðŸ™‚</div>
        <div>
          <div class="epTitle" id="epTitle">Checkingâ€¦</div>
          <div class="epSub" id="epSub">Please wait mava</div>
        </div>
      </div>
      <div class="epBadge" id="epBadge" style="display:none;">NOT YET</div>
    </div>

    <div class="epPills" id="epPills" style="display:none;">
      <div class="epPill" id="epVisitText">Visit: â€”</div>
      <div class="epPill" id="epRuleText">â€”</div>
    </div>

    <div class="epNote" id="epNote" style="display:none;">
      Count will be added only after PIN verification.
    </div>

    <!-- âœ… Checkbox + OK (Enter PIN removed) -->
    <div class="epCheckRow" id="epCheckRow" style="display:none;">
      <input type="checkbox" id="epAckChk" />
      <div>
        <div class="epCheckText">Understood mava. PIN verify ayyaka ne count add avthundi.</div>
        <div class="epCheckHint">Checkbox tick cheste OK enable avtundi.</div>
      </div>
    </div>

    <div class="epLoading" id="epLoading" style="display:none;">Loadingâ€¦</div>

    <div class="epActions">
      <button type="button" class="epBtn" id="epCloseBtn">Close</button>
      <button type="button" class="epBtn epBtnPrimary" id="epOkBtn" disabled>OK</button>
    </div>
  </div>
</div>

<script>
  (function(){
    const overlay = document.getElementById('eligibilityPreviewOverlay');
    const badge   = document.getElementById('epBadge');
    const emoji   = document.getElementById('epEmoji');
    const title   = document.getElementById('epTitle');
    const sub     = document.getElementById('epSub');

    const pillsWrap = document.getElementById('epPills');
    const visitText = document.getElementById('epVisitText');
    const ruleText  = document.getElementById('epRuleText');

    const note    = document.getElementById('epNote');
    const loading = document.getElementById('epLoading');

    const checkRow = document.getElementById('epCheckRow');
    const ackChk   = document.getElementById('epAckChk');

    const closeBtn = document.getElementById('epCloseBtn');
    const okBtn    = document.getElementById('epOkBtn');

    function open(){
      if (!overlay) return;
      overlay.classList.add('is-open');
      overlay.setAttribute('aria-hidden','false');
    }

    // âœ… close supports "keepMain" option (OK click ki use avthadi)
    function close(opts){
      const keepMain = !!opts?.keepMain;

      if (!overlay) return;
      overlay.classList.remove('is-open');
      overlay.setAttribute('aria-hidden','true');

      // reset checkbox + ok
      if (ackChk) ackChk.checked = false;
      if (okBtn) okBtn.disabled = true;

      // âœ… cancel/close lo main checkbox OFF
      if (!keepMain && window.__setMainEligibilityBox){
        window.__setMainEligibilityBox(false);
      }
    }

    // âœ… Close button = cancel
    closeBtn?.addEventListener('click', () => close({ keepMain:false }));

    // âœ… Outside click = cancel
    overlay?.addEventListener('click', (e) => {
      if (e.target === overlay) close({ keepMain:false });
    });

    // âœ… Sub checkbox change: only OK enable/disable
    ackChk?.addEventListener('change', () => {
      if (okBtn) okBtn.disabled = !ackChk.checked;
    });

    // âœ… OK click = confirm -> main checkbox ON -> close without turning it OFF
    okBtn?.addEventListener('click', () => {
      if (!ackChk?.checked) return;

      if (window.__setMainEligibilityBox){
        window.__setMainEligibilityBox(true);
      }

      close({ keepMain:true });
    });

    window.EligibilityPreviewModal = {
      showLoading(){
        open();
        if (emoji) emoji.textContent = "â³";
        if (title) title.textContent = "Checkingâ€¦";
        if (sub)   sub.textContent   = "Please wait mava";

        if (badge) badge.style.display = "none";
        if (pillsWrap) pillsWrap.style.display = "none";
        if (note) note.style.display = "none";
        if (checkRow) checkRow.style.display = "none";
        if (loading) loading.style.display = "block";

        if (okBtn) okBtn.disabled = true;
        if (ackChk) ackChk.checked = false;
      },

      showEligible(payload){
        open();
        if (loading) loading.style.display = "none";

        if (emoji) emoji.textContent = "ðŸ˜Š";
        if (title) title.textContent = payload?.title || "Eligible âœ…";
        if (sub)   sub.textContent   = payload?.sub || "Ee visit verify chesthe complimentary unlock avvachu mava.";

        if (badge){
          badge.style.display = "inline-flex";
          badge.textContent = "ELIGIBLE";
          badge.style.background = "rgba(34,197,94,.15)";
          badge.style.border = "1px solid rgba(34,197,94,.35)";
          badge.style.color = "#bbf7d0";
        }

        if (pillsWrap) pillsWrap.style.display = "flex";
        if (visitText) visitText.textContent = payload?.visitText || "";
        if (ruleText)  ruleText.textContent  = payload?.ruleText  || "";

        if (note){
          note.style.display = "block";
          note.textContent = payload?.noteText || "Count will be added only after PIN verification.";
        }

        if (checkRow) checkRow.style.display = "flex";
        if (ackChk) ackChk.checked = false;
        if (okBtn) okBtn.disabled = true;
      },

      showNotYet(payload){
        open();
        if (loading) loading.style.display = "none";

        if (emoji) emoji.textContent = "ðŸ™‚";
        if (title) title.textContent = payload?.title || "Almost there ðŸ‘€";
        if (sub)   sub.textContent   = payload?.sub || "One more visit to unlock your complimentary.";

        if (badge){
          badge.style.display = "inline-flex";
          badge.textContent = "NOT YET";
          // (optional) reset eligible styles if previously set
          badge.style.background = "rgba(255,76,106,.10)";
          badge.style.border = "1px solid rgba(255,76,106,.30)";
          badge.style.color = "#ffd4dc";
        }

        if (pillsWrap) pillsWrap.style.display = "flex";
        if (visitText) visitText.textContent = payload?.visitText || "";
        if (ruleText)  ruleText.textContent  = payload?.ruleText  || "";

        if (note){
          note.style.display = "block";
          note.textContent = payload?.noteText || "Count will be added only after PIN verification.";
        }

        if (checkRow) checkRow.style.display = "flex";
        if (ackChk) ackChk.checked = false;
        if (okBtn) okBtn.disabled = true;
      },

      close: () => close({ keepMain:false }) // external close = cancel
    };
  })();
</script>
