<!-- ===== QR Generation Modal (with Branch + ShortID chips) ===== -->
<div id="qrcodeModal" class="oz-modal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="oz-card" role="document">
    <div class="oz-head">
      <div>
        <strong id="qrTitle">Branch · QR</strong>

        <!-- identity chips row -->
        <div class="qr-meta" aria-live="polite">
          <span class="chip" id="qrMetaBranch" title="Branch">—</span>
          <span class="chip" id="qrMetaUID" title="Branch UID">UID: ----</span>
          <span class="chip" id="qrMetaTag" title="Short Tag">#----</span>
          <span class="chip" id="qrMetaStaff" title="Staff">Staff: —</span>
          <span class="chip dev" id="qrMetaTTL" title="Rotating TTL">Rotating • TTL 03:00</span>
        </div>
      </div>

      <a href="#" class="oz-close" data-close aria-label="Close">✕</a>
    </div>

    <div class="oz-body qr-body">
      <!-- Left -->
      <div class="qr-left">
        <div class="qr-box" id="qrCanvasHolder" aria-live="polite" aria-label="QR area"></div>

        <div class="qr-count">
          <span>Expires in:</span> <strong id="qrCountdown">03:00</strong>
        </div>

        <div class="qr-actions">
          <button type="button" class="btn" id="qrRefresh">Refresh QR</button>
        </div>
      </div>

      <!-- Right -->
      <div class="qr-right">

        <!-- Manual PIN -->
        <div class="qr-pin" aria-live="polite">
          <div class="label">Manual PIN</div>

          <div class="pin-top">
            <strong id="qrPin">————</strong>
          </div>

          <div class="pin-actions pin-actions-row">
            <button type="button"
                    class="btn outline"
                    id="visitorPinGenerator">
              Visit PIN generate
            </button>

            <button type="button"
                    class="btn outline"
                    data-open="#offerVerificationModal">
              Verify Offer PIN
            </button>
          </div>

          <small class="muted">
            If camera fails, customer can enter this 4-digit PIN on their phone.
          </small>
        </div>

        <div class="qr-help">
          <p><strong>How to use:</strong></p>
          <ol>
            <li>Ask the customer to open their phone camera.</li>
            <li>They scan this QR and see the redeem screen.</li>
            <li>They tap <em>Confirm &amp; Redeem</em>.</li>
          </ol>
        </div>

      </div>
    </div>

    <div class="oz-foot">
      <button class="btn outline" data-close>Close</button>
    </div>
  </div>
</div>

{% include "offers/qr_generation/visitor_pin_generatemodal.html" %}
{% include "offers/qr_generation/offer_verification_modal.html" %}

<style>
  /* two buttons row */
  .qr-pin .pin-actions-row{
    width:100%;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    justify-content:center;
    margin:6px 0 6px;
  }
  .qr-pin .pin-actions-row .btn{
    width:100%;
    max-width:none;
  }
  @media (max-width:720px){
    .qr-pin .pin-actions-row{
      grid-template-columns:1fr;
    }
  }
</style>

<style>
  /* Shell */
  #qrcodeModal[aria-hidden="true"]{ display:none !important; }
  #qrcodeModal{ position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.68); z-index:9999; }
  #qrcodeModal .oz-card{
    width:min(880px,96vw); max-height:92vh; background:#fff; color:#1b2249;
    border:1px solid #e3e9ff; border-radius:14px; box-shadow:0 18px 48px rgba(27,34,73,.08);
    display:flex; flex-direction:column; overflow:hidden;
  }
  #qrcodeModal .oz-head, #qrcodeModal .oz-foot{
    background:#fff; flex:0 0 auto; padding:12px 16px; display:flex; align-items:center; justify-content:space-between;
    border-bottom:1px solid #e3e9ff;
  }
  #qrcodeModal .oz-foot{ border-top:1px solid #e3e9ff; border-bottom:none; justify-content:flex-end; gap:10px; }

  /* identity chips */
  .qr-meta{ display:flex; gap:8px; margin-top:6px; flex-wrap:wrap; }
  .qr-meta .chip{
    display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid #e3e9ff;
    border-radius:999px; font-size:12px; color:#47507a; background:#f7f9ff;
  }
  .qr-meta .chip.dev{ background:#fff7f0; border-color:#ffd7b8; color:#8a4a00; }

  .qr-body{ padding:16px; overflow:auto; display:grid; grid-template-columns: 1fr 1fr; gap:18px; }
  .qr-left{ display:flex; flex-direction:column; align-items:center; gap:12px; }
  .qr-box{
    width:260px; height:260px; border:1px dashed #cfd8ff; border-radius:12px;
    display:grid; place-items:center; background:#f8faff;
  }
  .qr-box img{ width:240px; height:240px; image-rendering:pixelated; }
  .qr-count{ font-weight:700; font-size:16px; }
  .qr-actions{ display:flex; gap:10px; }

  .qr-right{ display:flex; flex-direction:column; gap:14px; }

  .qr-pin .label{ font-weight:700; margin-bottom:6px; }
  .qr-help p{ margin:0 0 8px; }
  .qr-help .muted, .qr-pin .muted{ color:#6b7280; font-size:12px; }

  #qrcodeModal .btn{
    background:#4c74ff; color:#fff; border:1px solid #3e63e6;
    padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer;
  }
  #qrcodeModal .btn.outline{ background:#fff; color:#1b2249; border:1px solid #d6defc; }

  /* Manual PIN layout */
  .qr-pin .pin-top{
    width:100%;
    display:flex;
    justify-content:center;
    align-items:center;
    padding:10px 0 6px;
  }
  .qr-pin .pin-top strong#qrPin{
    font-size:22px;
    font-weight:900;
    letter-spacing:0.25em;
  }
  .qr-pin .pin-actions{
    width:100%;
    display:flex;
    justify-content:center;
    margin:6px 0 6px;
  }
  .qr-pin .pin-actions .btn{
    width:100%;
    max-width:260px;
  }

  @media (max-width:720px){
    .qr-body{ grid-template-columns:1fr; }
    .qr-right{ order:2; }
    .qr-left{
      position:sticky; top:8px;
      z-index:1;
      background:linear-gradient(#fff 60%, rgba(255,255,255,0));
      padding-bottom:6px;
    }
    .qr-box{ width:min(320px, 86vw); height:min(320px, 86vw); }
    .qr-box img{ width:calc(100% - 20px); height:calc(100% - 20px); }
    .qr-count{ font-size:15px; }
  }
  @media (prefers-reduced-motion:reduce){ #qrcodeModal{ transition:none; } }
</style>

<script>
/* Config */
window.OZQR = {
  MODAL_ID: 'qrcodeModal',
  START_URL: '/qrg/start',
  flags: { SHOW_DEBUG: true },
  state: { countdown:180, tickTimer:null, payload:'', pin:'', branch:'—', desk:'—', tag:'----', uid:'', seed:'', staffName: '', staffCode: '' }
};
</script>

<script>
/* DOM helpers + renderers */
(() => {
  const OZ = window.OZQR, S = OZ.state;
  OZ.$ = (s)=>document.querySelector(s);
  OZ.setText=(s,t)=>{const e=OZ.$(s); if(e) e.textContent=t;};

  function shortTagFromUID(uid){
    if(!uid) return '----';
    let h = 2166136261 >>> 0;
    for (let i = 0; i < uid.length; i++) {
      h ^= uid.charCodeAt(i);
      h = (h * 16777619) >>> 0;
    }
    const c = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    let o = "", x = h >>> 0;
    for (let i = 0; i < 6; i++) { o = c[x % 36] + o; x = Math.floor(x / 36); }
    return o;
  }

  OZ.setOpen=(open)=>{
    const m=OZ.$('#'+OZ.MODAL_ID);
    if(!m) return;
    m.setAttribute('aria-hidden',open?'false':'true');
    document.body.classList.toggle('modal-open',!!open);
  };

  OZ.renderHead = () => {
    OZ.setText('#qrTitle', (S.branch || 'Branch') + ' · QR');
    OZ.setText('#qrMetaBranch', S.branch || '—');
    OZ.setText('#qrMetaUID', 'UID: ' + (S.uid || '----'));
    OZ.setText('#qrMetaTag', '#'+(S.tag || '----'));

    const staffText = S.staffCode
      ? `Staff: ${S.staffCode}`
      : (S.staffName ? `Staff: ${S.staffName}` : 'Staff: —');
    OZ.setText('#qrMetaStaff', staffText);

    const ttlChip = OZ.$('#qrMetaTTL');
    if(ttlChip) ttlChip.style.display = (window.OZQR.flags?.SHOW_DEBUG ? '' : 'none');
  };

  OZ.renderQR=()=>{
    const holder=OZ.$('#qrCanvasHolder'); if(!holder||!S.payload) return;
    const url='https://api.qrserver.com/v1/create-qr-code/?size=240x240&margin=0&data='+encodeURIComponent(S.payload)+'&t='+Date.now();
    holder.innerHTML=`<img alt="QR" width="240" height="240" src="${url}">`;
  };

  OZ.renderPIN = () => {
    const raw = String(S.pin || '').match(/\d{4}/)?.[0] || '';
    OZ.setText('#qrPin', raw || '————');
  };

  const mmss = s => `${String(Math.floor(s / 60)).padStart(2, '0')}:${String(s % 60).padStart(2, '0')}`;

  OZ.updateCountdown = () => {
    const nowSec = Math.floor(Date.now() / 1000);
    const remaining = Math.max(0, (S.expUnix || nowSec) - nowSec);
    S.countdown = remaining;

    OZ.setText('#qrCountdown', mmss(remaining));
    if (window.OZQR.flags?.SHOW_DEBUG) {
      OZ.setText('#qrMetaTTL', 'Rotating • TTL ' + mmss(remaining));
    }

    if (remaining <= 0) {
      OZ.stopTimer();
      OZ.refresh();
    }
  };

  OZ.stopTimer = () => {
    if (S.tickTimer) {
      clearInterval(S.tickTimer);
      S.tickTimer = null;
    }
  };

  OZ.startTimer = () => {
    OZ.stopTimer();
    OZ.updateCountdown();
    S.tickTimer = setInterval(OZ.updateCountdown, 1000);
  };

  window.__oz_shortTagFromUID = shortTagFromUID;
})();
</script>

<script>
/* API (mint/refresh) */
(() => {
  const OZ = window.OZQR, S = OZ.state;
  const tagFromUID = window.__oz_shortTagFromUID || ((u)=>'----');

  function parseSeed(seed){
    const out={};
    try{
      if(seed && seed.includes('://')){
        const qp = seed.split('://')[1];
        const usp = new URLSearchParams(qp);
        const b = usp.get('branch');
        if (b) out.branchPid = String(b);
        const d = usp.get('desk');
        if (d) out.desk = d;
      }
    }catch(_){}
    return out;
  }

  OZ.mintFromServer = async (seed = '') => {
    const params = parseSeed(seed);
    const url = new URL(OZ.START_URL, location.origin);
    if (params.branchPid) url.searchParams.set('branch', params.branchPid);
    if (params.desk)      url.searchParams.set('desk', params.desk);

    const res = await fetch(url.toString(), {
      method: 'GET',
      credentials: 'same-origin',
      headers: { Accept: 'application/json' }
    });
    const ct = res.headers.get('content-type') || '';
    if (!ct.includes('application/json')) throw new Error('Non-JSON');
    const data = await res.json();
    if (!res.ok || data.ok === false) throw new Error(data.error || ('HTTP ' + res.status));

    S.payload = data.payload || '';
    S.pin     = data.pin || '';

    const ttl = Math.max(30, parseInt(data.expires_in ?? 180, 10) || 0);
    const nowSec = Math.floor(Date.now() / 1000);
    S.expUnix   = nowSec + ttl;
    S.countdown = ttl;

    S.desk = data.desk || params.desk || '—';
    S.staffName = (data.staff_name || '').toString();
    S.staffCode = (data.staff_code || '').toString();

    S.uid = (data.branch_public_id || data.uid || params.branchPid || '').toString();

    const label = (data.branch || '').toString();
    S.branch = label || '—';
    S.tag    = (data.branch_tag || '').toString().trim() || (S.uid ? tagFromUID(S.uid) : tagFromUID(S.branch));

    OZ.renderHead();
    OZ.renderQR();
    OZ.renderPIN();
  };

  OZ.mintLocally = (seed = '') => {
    const params = parseSeed(seed);
    const ttl = 180;
    const nowSec = Math.floor(Date.now() / 1000);
    S.payload   = seed || (location.origin + '/offers/local-demo');
    S.pin       = '';
    S.countdown = ttl;
    S.expUnix   = nowSec + ttl;
    S.branch    = 'demo-branch';
    S.uid       = params.branchPid || 'DEMOUID1';
    S.tag       = tagFromUID(S.uid);
    S.staffName = '';
    S.staffCode = '';
    S.desk      = params.desk || 'A1';
    OZ.renderHead(); OZ.renderQR(); OZ.renderPIN();
  };

  OZ.build = async (seed='') => {
    S.seed = seed || S.seed || '';
    try { await OZ.mintFromServer(S.seed); }
    catch(e){ console.warn('[QR] fallback local mint:', e); OZ.mintLocally(S.seed); }
    OZ.startTimer();
  };

  OZ.refresh = async () => { OZ.stopTimer(); await OZ.build(S.seed); };
})();
</script>

<script>
/* Events + auto-open persistence (QR modal ONLY) */
(() => {
  const OZ = window.OZQR;

  function getBranchKey() {
    const b = document.body;
    if (!b || !b.dataset) return "default";
    return (b.dataset.branchUid || b.dataset.branchId || "default");
  }

  const BRANCH_KEY = getBranchKey();

  OZ.AUTO = {
    OPEN_KEY: `ozqr_open:${BRANCH_KEY}`,
    SEED_KEY: `ozqr_seed:${BRANCH_KEY}`,
  };

  OZ.saveOpenState=(seed='')=>{ try{ sessionStorage.setItem(OZ.AUTO.OPEN_KEY,'1'); if(seed) sessionStorage.setItem(OZ.AUTO.SEED_KEY,seed);}catch(_){ } };
  OZ.clearOpenState=()=>{ try{ sessionStorage.removeItem(OZ.AUTO.OPEN_KEY); sessionStorage.removeItem(OZ.AUTO.SEED_KEY);}catch(_){ } };

  document.addEventListener('click',(e)=>{
    const openEl=e.target.closest('[data-open="#'+OZ.MODAL_ID+'"]');
    if(openEl){
      e.preventDefault();
      const seed=openEl.getAttribute('data-qr')||'';
      OZ.saveOpenState(seed);
      OZ.build(seed).then(()=>OZ.setOpen(true));
      return;
    }
    const closeEl=e.target.closest('[data-close]');
    if(closeEl && closeEl.closest('#'+OZ.MODAL_ID)){
      e.preventDefault();
      OZ.clearOpenState();
      OZ.setOpen(false);
      window.OZQR.stopTimer?.();
    }
  });

  document.getElementById('qrRefresh')?.addEventListener('click',(e)=>{ e.preventDefault(); OZ.refresh(); });

  async function autoOpenIfNeeded(){
    if(sessionStorage.getItem(OZ.AUTO.OPEN_KEY)!=='1') return;
    const seed=sessionStorage.getItem(OZ.AUTO.SEED_KEY)||'';
    await OZ.build(seed);
    OZ.setOpen(true);
  }
  document.addEventListener('DOMContentLoaded', autoOpenIfNeeded);
  window.addEventListener('pageshow', (e)=>{ if(e.persisted) autoOpenIfNeeded(); });
})();
</script>

<!-- ✅ GLOBAL modal open/close for included sub-modals (nested allowed) -->
<script>
(function(){
  function openModal(sel){
    const m = document.querySelector(sel);
    if(!m) return;
    m.classList.add('is-open');
    m.setAttribute('aria-hidden','false');
  }
  function closeModal(m){
    if(!m) return;
    m.classList.remove('is-open');
    m.setAttribute('aria-hidden','true');
  }

  document.addEventListener('click', (e) => {
    // open any modal by selector
    const openEl = e.target.closest('[data-open]');
    if(openEl){
      const sel = openEl.getAttribute('data-open');
      // ✅ avoid double-handling qrcodeModal (QR has its own logic)
      if(sel === '#qrcodeModal') return;
      if(sel && sel.startsWith('#')){
        e.preventDefault();
        openModal(sel);
      }
      return;
    }

    // close any modal
    const closeEl = e.target.closest('[data-close]');
    if(closeEl){
      const m = closeEl.closest('.oz-modal');
      if(m){
        // ✅ allow QR modal close logic to run for QR modal
        if(m.id === 'qrcodeModal') return;
        e.preventDefault();
        closeModal(m);
      }
    }
  });

  // optional API
  window.OZModal = { open: openModal, close: closeModal };
})();
</script>
