{# homepage/testqr_modal.html #}
{% load static %}

<!-- QRCode JS library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- QR Modal -->
<div id="qrcodeModal"
     style="
        position:fixed;
        inset:0;
        display:none;
        align-items:center;
        justify-content:center;
        background:rgba(0,0,0,.55);
        z-index:60;
     ">

  <!-- outer dark card -->
  <div style="
        background:#11183a;
        border-radius:24px;
        padding:16px 16px 18px;
        width:100%;
        max-width:260px;
        color:#e8ecff;
        box-shadow:0 18px 40px rgba(0,0,0,.6);
        font-family:system-ui,Arial,sans-serif;
     ">

    <!-- close icon -->
    <div style="display:flex; justify-content:flex-end;">
      <button type="button"
              data-close="qrcodeModal"
              style="
                border:0;
                background:transparent;
                color:#bfc9ff;
                cursor:pointer;
                padding:2px 4px;
                font-size:16px;
              ">
        Ã—
      </button>
    </div>

    <!-- gradient card -->
    <div style="
          background:linear-gradient(145deg,#2264ff,#2db5ff);
          border-radius:20px;
          padding:12px 10px 14px;
          text-align:center;
          color:#f5f7ff;
        ">

      <div style="font-size:11px; letter-spacing:.08em; text-transform:uppercase; opacity:.9; margin-bottom:6px;">
        UPI QR
      </div>

      <!-- QR container -->
      <div style="
            background:#ffffff;
            border-radius:16px;
            padding:10px;
            display:flex;
            align-items:center;
            justify-content:center;
            min-width:170px;
            min-height:170px;
            box-shadow:0 4px 12px rgba(0,0,0,.22);
            margin-bottom:10px;
          ">
        <div id="qrPreview" style="position:relative; width:170px; height:170px;"></div>
      </div>

      <div style="font-size:13px; font-weight:600; letter-spacing:.08em; text-transform:uppercase;">
        Scan &amp; Pay
      </div>
      <div style="font-size:11px; opacity:.8; margin-top:2px;">
        Works with any UPI app
      </div>
    </div>

    <!-- Close button -->
    <div style="display:flex; justify-content:center; margin-top:10px;">
      <button type="button"
              data-close="qrcodeModal"
              style="
                border-radius:999px;
                border:1px solid #2a376b;
                background:#0b1028;
                color:#bfc9ff;
                padding:6px 22px;
                font-size:13px;
                cursor:pointer;
              ">
        Close
      </button>
    </div>
  </div>
</div>

<script>
  // center photo path
  const QR_CENTER_IMAGE = "{% static 'image/forpayment.jpg' %}";

  (function () {
    const modalId = "qrcodeModal";
    const modal = document.getElementById(modalId);
    if (!modal) return;

    document.addEventListener("click", function (e) {
      const trigger = e.target.closest('[data-open="#' + modalId + '"]');
      if (!trigger) return;

      e.preventDefault();

      const qrValue = trigger.getAttribute("data-qr") || "";
      const qrContainer = document.getElementById("qrPreview");
      if (!qrContainer) return;

      // clear old
      qrContainer.innerHTML = "";

      // QR size
      const size = 170;

      new QRCode(qrContainer, {
        text: qrValue,
        width: size,
        height: size,
        correctLevel: QRCode.CorrectLevel.H   // max error correction
      });

      // overlay photo after QR is ready
      setTimeout(() => {
        const img = new Image();
        img.src = QR_CENTER_IMAGE;

        img.onload = function () {
          const imgSize = 96; // ~55% of QR, safe for scan

          img.style.position = "absolute";
          img.style.left = "50%";
          img.style.top = "50%";
          img.style.width = imgSize + "px";
          img.style.height = imgSize + "px";
          img.style.transform = "translate(-50%, -50%)";
          img.style.borderRadius = "12px";
          img.style.background = "white";
          img.style.padding = "4px";
          img.style.boxShadow = "0 0 8px rgba(0,0,0,.35)";

          qrContainer.appendChild(img);
        };
      }, 150);

      modal.style.display = "flex";
    });

    // close modal
    modal.addEventListener("click", function (e) {
      if (e.target === modal) {
        modal.style.display = "none";
        return;
      }
      const closeBtn = e.target.closest('[data-close="' + modalId + '"]');
      if (closeBtn) {
        e.preventDefault();
        modal.style.display = "none";
      }
    });
  })();
</script>
